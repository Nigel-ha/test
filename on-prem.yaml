
      - task: AmazonWebServices.aws-vsts-tools.AWSShellScript.AWSShellScript@1
        displayName: 'Generate kubeconfig'
        env:
          externalID: $(externalid)
        inputs:
          awsCredentials: ${{ parameters.serviceConnection }}
          regionName: ap-southeast-2
          scriptType: inline
          inlineScript: |
            #!/bin/bash
            set -e
            . scripts/setup.sh "${{parameters.clusterName}}"

            # Generate kubeconfig file
            aws eks update-kubeconfig --name "${clusterName}" --region ap-southeast-2 --kubeconfig kubeconfig

            # Using yq to set "insecure-skip-tls-verify" to true
            yq e '.clusters[].cluster."insecure-skip-tls-verify" = true' -i kubeconfig

            # Remove "certificate-authority-data" field using yq
            yq e 'del(.clusters[].cluster."certificate-authority-data")' -i kubeconfig

            # Fetch and embed the token using yq
            token=$(aws eks get-token --cluster-name "${clusterName}" --region ap-southeast-2 --query 'status.token' --output text)
            yq e '.users[0].user.token = "'"$token"'"' -i kubeconfig

            # Copy kubeconfig to artifact staging directory
            mkdir -p $(Build.ArtifactStagingDirectory)
            cp kubeconfig $(Build.ArtifactStagingDirectory)/kubeconfig
