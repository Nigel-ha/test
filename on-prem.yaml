
    - task: PowerShell@2
      displayName: 'Edit Hosts File with EKS Domain and NLB IP'
      env:
        nlb_alias: $(nlb_alias)
        eks_domain: $(eks_domain)
      inputs:
        targetType: 'inline'
        script: |
            # Set environment variables
            $env:nlb_alias = '$(nlb_alias)'
            $env:eks_domain = '$(eks_domain)'

            try {
                $NLB_IP = [System.Net.Dns]::GetHostAddresses($env:nlb_alias) | Select-Object -First 1 | ForEach-Object { $_.IPAddressToString }
            } catch {
                Write-Error "Failed to resolve NLB alias to IP address."
                exit 1
            }

            if (-not $NLB_IP) {
                Write-Error "Failed to get IP address for NLB alias."
                exit 1
            }

            Write-Host "NLB IP Address: $NLB_IP"
            Write-Host "EKS Domain: $($env:eks_domain)"

            # Update the Windows Hosts File
            $HostsFile = "C:\Windows\System32\drivers\etc\hosts"
            $HostsEntry = "$NLB_IP`t$($env:eks_domain)"

            # Check if entry already exists
            $HostsContent = Get-Content -Path $HostsFile -ErrorAction Stop
            if ($HostsContent -contains $HostsEntry) {
                Write-Host "Hosts file already contains the required entry."
            } else {
                # Add the entry to the hosts file
                Add-Content -Path $HostsFile -Value $HostsEntry -ErrorAction Stop
                Write-Host "Hosts file updated successfully."
            }

            cat $HostsFile
